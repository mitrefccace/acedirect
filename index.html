<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>ACE</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="./bower_components/AdminLTE/bootstrap/css/bootstrap.css">
		<!-- Bootstrap Toggle v2.2.0 -->
        <link rel="stylesheet" href="./bower_components/bootstrap-toggle/css/bootstrap-toggle.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="./bower_components/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="./bower_components/Ionicons/css/ionicons.min.css">
        <!-- Theme style -->
        <link rel="stylesheet" href="./bower_components/AdminLTE/dist/css/AdminLTE.css">
        <!-- AdminLTE Skins  -->
        <link rel="stylesheet" href="./bower_components/AdminLTE/dist/css/skins/_all-skins.min.css">
        <!-- Custom Portal stylesheet -->
        <link rel="stylesheet" href="css/ca-portal.css">     

		<style>			
			.control-sidebar.control-sidebar-open, 
			.control-sidebar.control-sidebar-open + .control-sidebar-bg {
				right: 0 !important;
			}
			.direct-chat-text {
				margin: 5px 0 0 5px;
			} 
            .right .direct-chat-text {
				margin-right: 5px !important;
			}   
		</style>
		<script>
			if (sessionStorage.getItem('accesstoken') === null)
				window.location.replace("/login.html");
		</script>

    </head>
    <body class="hold-transition skin-purple sidebar-mini">
        <div class="wrapper">

            <header class="main-header">

                <!-- Logo -->
                <a href="" class="logo">
                    <!-- mini logo for sidebar mini 50x50 pixels -->
                    <span class="logo-mini"><b>ACE</b></span>
                    <!-- logo for regular state and mobile devices -->
                    <span class="logo-lg" ><b>ACE</b>&nbsp;<span id="logo-text">Connect Lite</span></span>
                </a>

                <!-- Header Navbar: style can be found in header.less -->
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                    <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                        <span class="sr-only">Toggle navigation</span>
                    </a>
                    <div id="agentStatusInfo" class="col-lg-2 col-md-2 col-sm-2 col-lg-offset-2 col-md-offset-2" style="white-space:nowrap;">
                        <label class="control-label">Call Duration: </label>&nbsp;&nbsp;<span id="duration" class="text-gray">0 sec</span>
                    </div>
                    <div class="col-lg-1 col-md-1 col-sm-1 col-lg-offset-1 col-md-offset-1">
                        <button id="assistanceBtn" type="button" class="btn btn-danger" style="overflow: hidden;text-overflow:ellipsis;" onclick="requestAssistance()">Assistance</button>
                    </div>
                    <!-- Navbar Right Menu -->
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <!-- User Account: style can be found in dropdown.less -->
                            <li class="dropdown user user-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <img src="bower_components/AdminLTE/dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
                                    <span class="hidden-xs" id="agentname-header"></span>
                                </a>
                                <ul class="dropdown-menu">
                                    <!-- User image -->
                                    <li class="user-header">
                                        <img src="bower_components/AdminLTE/dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                                        <p>
                                            <span id="agentname-headerdropdown"></span>
											<br>
                                            <span id="agentrole-headerdropdown"></span>
                                        </p>
                                    </li>
                                    <!-- Menu Footer-->
                                    <li class="user-footer">
                                        <div class="pull-left">
                                            <a href="#" class="btn btn-default btn-flat">Profile</a>
                                        </div>
                                        <div class="pull-right">
                                            <a href="#" class="btn btn-default btn-flat" onclick="logout()">Sign out</a>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <!-- Control Sidebar Toggle Button -->
                            <li>
                                <a href="#" data-toggle="modal" data-target="#licModal"><i class="fa fa-info-circle"></i></a>
                            </li>
							<li>
                                <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>


            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar">
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    <!-- Sidebar user panel -->
                    <div class="user-panel">
                        <div class="pull-left image">
                            <img src="bower_components/AdminLTE/dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                        </div>
                        <div class="pull-left info">
                            <p><span id="agentname-sidebar"></span></p>
                            <span><i id="status-icon" class="fa fa-circle text-warning"></i></span>&nbsp;&nbsp;&nbsp;<span id="user-status">Away</span>
                        </div>
                    </div>
                    <!-- sidebar menu: : style can be found in sidebar.less -->
                    <ul class="sidebar-menu">
                        <li class="header">USER STATUS</li>
						<li onclick="pauseQueues();"><a href="#"><i class="fa fa-circle text-yellow"></i> <span>Away</span></a></li>
						<li onclick="unpauseQueues();"><a href="#"><i class="fa fa-circle text-green"></i> <span>Ready</span></a></li>
                        <li class="header">MAIN NAVIGATION</li>
                        <li>
                            <a href="#">
                                <i class="fa fa-desktop"></i> <span id="nav-desktop">CA Desktop</span>
                            </a>
                        </li>
						<li id="sidebar-queues" class="header" hidden><span id="nav-desktop">QUEUES</span></li>						
						<li id="sidebar-complaints" onclick="$('#complaintsanchor').click()" hidden>
							<a href="#">
								<i class="fa fa-thumbs-down"></i>
								<span>Complaints</span>
								<span id="complaintsInCall" class="pull-right-container" hidden>
									<small class="label pull-right bg-red">in call</small>
								</span>
							</a>
						</li>
						<li id="sidebar-geninfo"  onclick="$('#geninfoanchor').click()" hidden>
							<a href="#">
								<i class="fa fa-question-circle"></i> 
								<span>General Info</span>
								<span id="geninfoInCall" class="pull-right-container" hidden>
									<small class="label pull-right bg-red">in call</small>
								</span>
							</a>
						</li>

                    </ul>
                </section>
                <!-- /.sidebar -->
            </aside>

            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1 id="section-header">CA Desktop</h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-desktop"></i> Home</a></li>
                        <li class="active" id="breadcrumb-header">CA Desktop</li>
                    </ol>
                </section>

                <!-- Main content -->
                <section class="content">
                    <!-- Main Row -->
                    <div class="row">

                        <!-- Left Col -->
                        <section class= col-lg-5>										
							<div class="col-md-12">

								<div class="box" id="call-info-box">
									<div class="box-header with-border">
										<i class="fa fa-phone"></i>
										<h3 class="box-title">Call Information</h3>
										<div class="box-tools pull-right">
											<button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
										</div>
									</div><!-- /.box-header -->
									<div class="box-body" id="callinfodiv">
										<div class="row">
											<div class="col-lg-6">
												<label class="control-label">Inbound</label>
												<label id="inbounddhohlabel"><i class="fa fa-deaf"></i></label>
												<div>
													<label class="form-control" id="inboundnumber"></label>
												</div>
											</div>										
											<div class="col-lg-6">
												<label class="control-label">Outbound</label>
												<label id="outbounddhohlabel"><i class="fa fa-deaf"></i></label>
												<div>
													<label class="form-control" id="outboundnumber"></label><!-- input text did not work -->
												</div>
											</div>
										</div>
									</div>
                                    <br>
                                    <div class="row">
                                        <div class="form-group text-center">
                                            <input type="button" class="btn btn-success" id="btnOriginate" value="Connect Call" onclick='originate();' />
                                            <input type="hidden" name="destexten" id="destexten" value="">               
                                        </div>
                                    </div>
								</div>
								<div class="box direct-chat direct-chat-primary" id="userchat" hidden>
									<div class="box-header with-border">
										<i class="fa fa-comments"></i>
										<h3 class="box-title">User Chat</h3>
										<div class="box-tools pull-right">
											<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
											</button>
										</div>
									</div>
									<div class="box-body">
										<!-- Conversations are loaded here -->
										<div class="direct-chat-messages" id="chat-messages"></div>
										<div class="direct-chat-timestamp text-bold" id="rtt-typing" style="margin-left: 10px; min-height: 20px"></div>
									</div>
									<div class="box-footer">
										<form name="chatsend" id="chatsend">
											<div class="input-group">
												<input type="hidden" id="displayname">
												<input type="text" id="newchatmessage" placeholder="Type Message ..." class="form-control" autocomplete="off" required>
												<span class="input-group-btn">
													<button  class="btn btn-primary btn-flat" type="submit">Send</button>
												</span>
											</div>
										</form>
									</div>
								</div>

                                <div class="nav-tabs-custom" id="scriptscontainer">
                                    <!-- Tabs within a box -->
                                    <ul class="nav nav-tabs pull-right">
                                        <li><a href="#complaint-scripts-tab" data-toggle="tab" aria-expanded="true">Complaint</a></li>
                                        <li class="active"><a href="#general-scripts-tab" data-toggle="tab" aria-expanded="false">General</a></li>
                                        <li class="pull-left header"><i class="fa fa-pencil"></i>Scripts</li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane" id="complaint-scripts-tab">
                                            <h3 class="text-center">Complaints Scripts</h3>
                                            <div class="form-group">
                                                <label>Script Content</label>
                                                <textarea id="complaints_script_content" class="form-control" rows="10" placeholder="Enter ..."></textarea>
                                            </div>
                                        </div>
                                        <div class="tab-pane active" id="general-scripts-tab">
                                            <h3 class="text-center">General Info. Scripts</h3>
                                            <div class="form-group">
                                                <label>Script Content</label>
                                                <textarea id="info_script_content" class="form-control" rows="10" placeholder="Enter ..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

							</div>
                        </section>

                        <section class="col-lg-7">		
                            <div class="col-md-12">

                                <div class="nav-tabs-custom">
                                    <!-- Tabs within a box -->
                                    <ul class="nav nav-tabs pull-right">
                                        <li id="ticketTab"><a id="ticketTabTitle" href="#ticketinfo" data-toggle="tab" aria-expanded="true">Ticket Info.</a></li>
                                        <li class="active"><a href="#vrsinfo" data-toggle="tab" aria-expanded="false">VRS Info.</a></li>
                                        <li class="pull-left header"><i class="fa fa-info-circle"></i>Call Details  <small id="notickettxt" class="text-danger" hidden>(no ticket)</small></li>
                                    </ul>

                                    <div class="tab-content">
                                        <div class="tab-pane active" id="vrsinfo">
                                            <form name="userform" id="userform" autocomplete="off">
                                                <div class="row">
                                                    <div class="col-lg-4">
                                                        <div class="form-group">
                                                            <label class="control-label">First Name</label>
                                                            <div>
                                                                <input type="text" class="form-control" id="callerFirstName" name="fname"autocomplete="off"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="form-group">
                                                            <label class="control-label">Last Name</label>
                                                            <input type="text" class="form-control" id="callerLastName" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <label class="control-label">Phone</label>
                                                        <div>
                                                            <input type="text" class="form-control" id="callerPhone" name="phone" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="form-group">
                                                            <label class="control-label">Address</label>
                                                            <input type="text" class="form-control" id="callerAddress1" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-lg-4">
                                                        <div class="form-group">
                                                            <label class="control-label">City/Town</label>
                                                            <input type="text" class="form-control" id="callerCity" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="form-group">
                                                            <label class="control-label">State</label>
                                                            <input type="text" class="form-control" id="callerState" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="form-group">
                                                            <label class="control-label">Zip Code</label>
                                                            <input type="text" class="form-control" id="callerZipcode" autocomplete="off"/>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">                                                
                                                    <div class="col-lg-12">
                                                        <div class="form-group">
                                                            <label class="control-label">Email</label>
                                                            <div>
                                                                <input type="email" class="form-control" id="callerEmail" name="email" autocomplete="off" required/>
                                                            </div>
                                                        </div>
                                                    </div>
												</div>
                                                <div class="row">
                                                    <div class="form-group text-center">
                                                        <input type="button" class="btn btn-warning"  id="btnClear" value="Finished" onclick="finished();" />
														<!--input type="button" class="btn btn-success"  id="btnTest" value="TEST BUTTON" /-->
                                                    </div>
                                                </div>
                                            </form>
                                        </div>


                                        <div class="tab-pane" id="ticketinfo">
                                            <form name="ticketForm" id="ticketForm" autocomplete="off">
                                                <div class="row">
                                                    <div class="col-lg-4 form-group">
                                                        <label class="control-label">Assignee</label>                                                        
                                                        <input type="text" class="form-control"  id="assignee" autocomplete="off"/>                                                                   
                                                    </div>
                                                    <div class="col-lg-4 form-group"> 
                                                        <label class="control-label">Requester</label>
                                                        <input type="text" class="form-control" id="requester"  autocomplete="off"/>
                                                    </div>
                                                    <div class="col-lg-4 form-group">
                                                        <label class="control-label">Last Updated</label>
                                                        <input type="text" id="lastupdated" class="form-control" autocomplete="off" disabled/>                                                    
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-8 form-group">
                                                        <label class="control-label">Subject</label>            
                                                        <input type="text" id="subject" class="form-control" name="subject" autocomplete="off" required/>
                                                    </div>
                                                    <div class="col-lg-4 form-group">
                                                        <label class="control-label">Ticket ID</label>
                                                        <input type="text" id="ticketId" class="form-control"  autocomplete="off" disabled/>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-12 form-group">
                                                        <label class="control-label text-left">Problem Description</label>                                                       
                                                        <textarea rows="3" id="problemdesc" class="form-control" name="desc"  required ></textarea>                                                                                                            
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="form-group">
                                                            <label class="control-label text-left">Resolution</label>
                                                            <textarea rows="3" id="resolution" class="form-control"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="form-group pull-right">
                                                            <input type="button" class="btn btn-primary"  id="btnModifyTicket" value="Save" onclick="modifyTicket()" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div id="alertPlaceholder" class="col-lg-12">
                                                    </div>
                                                </div>											
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </section>


                    </div><!-- /.row -->
                </section><!-- /.content -->
            </div><!-- /.content-wrapper -->

            <footer class="main-footer">
                <div class="pull-right hidden-xs">
                    <b>Version</b> 1.0
                </div>
                <strong>Copyright &copy; 2016.</strong> All rights reserved.
            </footer>

            <!-- Control Sidebar -->
            <aside class="control-sidebar control-sidebar-dark" style="width: 400px; right:-400px">
                <!-- Create the tabs -->
                <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
                    <li class="active"><a href="#control-sidebar-agents-tab" data-toggle="tab"><i class="fa fa-users"></i>&nbsp;&nbsp;Agents</a></li>
                    <li><a href="#control-sidebar-videomail-tab" data-toggle="tab"><i class="fa fa-envelope-o"></i>&nbsp;&nbsp;Video Mail</a></li>
                    <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i>&nbsp;&nbsp;Settings</a></li>
                    <li id="debugtab"><a href="#control-sidebar-debug-tab" data-toggle="tab"><i class="fa fa-bug"></i></a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- Home tab content -->
					<div class="tab-pane active" id="control-sidebar-agents-tab">
						<div class="form-group">
                            <table id='agenttable' class="table table-hover">
								<thead>
									<tr>
										<th>Status&nbsp;&nbsp;&nbsp;</th>
										<th>Agent</th>
										<th>Ext</th>
										<th>Queues</th>
									</tr>
								</thead>          
                            </table>
						</div>
					</div>
					<!-- Debug tab content -->
                    <div class="tab-pane" id="control-sidebar-debug-tab">
						<input type="button" class="btn btn-danger" id="btndbgclear" value="Clear Debug Text" onclick='cleardbgtxt();' />
						<br>
						<div id="dbgtxt" style='height:400px;max-height: 400px;overflow-y:scroll;'></div>
                    </div><!-- /.tab-pane -->

                    <!-- Mail tab content -->
                    <div class="tab-pane" id="control-sidebar-videomail-tab" >
                        <div class="form-group">
                            <label>Mailbox Messages</label>
                            <table class="table table-hover">
                                <tr>
                                    <th>Caller ID</th>
                                    <th>Call Received</th>
                                    <th>Duration (min.)</th>
                                </tr>
                                <tr>
                                    <td>000-000-0000</td>
                                    <td>2016-04-01 08:00:00</td>
                                    <td>1</td>
                                </tr>
                                <tr>
                                    <td>111-000-0000</td>
                                    <td>2016-04-02 09:00:00</td>
                                    <td>0.5</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <!-- /.Mail tab content -->

                    <!-- Settings tab content -->
                    <div class="tab-pane active" id="control-sidebar-settings-tab">
                        <div class="well"  style='visibility:hidden'>                            
                            <h2>
                                Call Agent Information
                            </h2>
                            <br />
                            <table style='width: 100%'>
                                <tr>
                                    <td>
                                        <label style="height: 100%">
                                            Display Name:
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentDisplayName" value="" readonly placeholder="e.g. agent1" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label style="height: 100%">
                                            First Name:
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentFirstname" value="" readonly  placeholder="e.g. John" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label style="height: 100%">
                                            Last Name:
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentLastname" value="" readonly  placeholder="e.g. Doe" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label style="height: 100%">
                                            Role:
                                        </label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentRole" value=""  readonly  placeholder="e.g. call agent" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label style="height: 100%">Email:</label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentEmail" value=""  readonly placeholder="jDoe@email.com"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label style="height: 100%">Phone:</label>
                                    </td>
                                    <td>
                                        <input type="text" style="width: 100%; height: 100%" id="txtAgentPhone" value=""  readonly placeholder="e.g. 555-555-5555" />
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding:10px;text-align:center">
                                        <input type="button" class="btn btn-danger" id="btnLogout" value="LogOut" onclick='logout();' />
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </div><!-- /.tab-pane -->
                </div>
            </aside><!-- /.control-sidebar -->
            <!-- Add the sidebar's background. This div must be placed
                 immediately after the control sidebar -->
            <div class="control-sidebar-bg" style="width:400px; right:-400px"></div>

        </div><!-- ./wrapper -->

        <!-- Glass Panel -->
        <div id='divGlassPanel' class='glass-panel' style='visibility:hidden'></div>

		<!-- License Modal -->
		<div class="modal fade" id="licModal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" id="licModalLabel">Copyright Notices</h4>
					</div>
					<div class="modal-body">
						<div id="licModalBody"></div> 
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<!-- VRS Input Modal -->
		<div class="modal fade" id="myVrsModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">What is your VRS Number?</h4>
					</div>
					<div class="modal-body">
						<div class="alert alert-danger" id="ivrsmessage" hidden></div>
						<div class="form-group">
							<label for="usr">VRS number:</label>
							<input type="text" class="form-control input-lg" id="ivrsnum" placeholder="VRS Number" data-inputmask="'mask': '(999) 999-9999'" data-mask >
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default"  id="submitvrs" >Submit</button>
					</div>
				</div>
			</div>
		</div>



		<!-- ==================Le javascript ================================ -->
		<!-- jQuery v2.1.4 -->
		<script src="bower_components/AdminLTE/plugins/jQuery/jquery-2.2.3.min.js"></script>
		<!-- socket.io-client -->
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<!-- Bootstrap 3.3.5 -->
		<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
		<!-- Decode JWT tokens -->
		<script type="text/javascript" src="bower_components/jwt-decode/build/jwt-decode.min.js"></script>
		<!-- timer.jquery 0.6.3 -->
		<script type="text/javascript" src='bower_components/timer.jquery/dist/timer.jquery.min.js'></script>
		<!-- moment.js 2.15.1 -->
        <script type="text/javascript" src='bower_components/moment/moment.js'></script>
		<script type="text/javascript" src="bower_components/AdminLTE/plugins/input-mask/jquery.inputmask.js"></script>
		<!-- AdminLTE App -->
		<script src="bower_components/AdminLTE/dist/js/app.min.js"></script>
		<!-- DataTables 1.10.12 -->
		<script type="text/javascript" src="./bower_components/datatables.net/js/jquery.dataTables.min.js"></script>

		<script>
		var socket;
		var extensionMe;
		var queueNameMe;
		var channelMe;
		var assistanceURL = "";
		var ticketTabFade;

		function connect_socket() {
			if (sessionStorage.getItem('accesstoken') === null)
				logout();
			console.log('connect_socket');
			socket = io.connect('https://' + window.location.host, {
				query: 'token=' + sessionStorage.accesstoken,
				forceNew: true
			});

			socket.on('connect', function () {
				debugtxt('connect', {"no": "data"});
				console.log('authenticated');

				//get the payload form the token
				var payload = jwt_decode(sessionStorage.accesstoken);
				$('#loginModal').modal('hide');
				$('#statusmsg').text(""); //clear status text

				//populate call agent information
				$('#txtAgentDisplayName').val(payload.username);
				$('#txtAgentFirstname').val(payload.first_name);
				$('#txtAgentLastname').val(payload.last_name);
				$('#txtAgentRole').val(payload.role);
				$('#txtAgentEmail').val(payload.email);
				$('#txtAgentPhone').val(payload.phone);

				if (payload.role === "AD Agent") {
					document.title = 'ACE Direct';
					$('#ticketInfo').show();
					$('#userchat').show();
					$('#scriptscontainer').show();
					$('#displayname').val(payload.first_name + ' ' + payload.role);
					$('#call-info-box').remove();
					$('#nav-desktop').text('AD Desktop');
					$('#section-header').text('AD Desktop');
					$('#breadcrumb-header').text('AD Desktop');
					$('#logo-text').text('Direct')
					if (payload.queue_name === "ComplaintsQueue" || payload.queue_name === "GeneralQuestionsQueue") {
						$('#sidebar-queues').show();
						$('#scriptstab').show();
					}
					if (payload.queue_name === "ComplaintsQueue" || payload.queue2_name === "ComplaintsQueue") {
						$('#sidebar-complaints').show();
					}
					if (payload.queue_name === "GeneralQuestionsQueue" || payload.queue2_name === "GeneralQuestionsQueue") {
						$('#sidebar-geninfo').show();
					}
				} else {
					document.title = 'ACE Connect Lite';
					$('#ticketInfo').remove();
					$('#userchat').remove();
					$('#scriptscontainer').remove();
					$('#call-info-box').show();
					$('#nav-desktop').text('CA Desktop');
					$('#section-header').text('CA Desktop');
					$('#breadcrumb-header').text('CA Desktop');
					$('#logo-text').text('Connect Lite')
				}

				$('#agentname-sidebar').html(payload.first_name + " " + payload.last_name);
				$('#agentname-header').html(payload.first_name + " " + payload.last_name);
				$('#agentname-headerdropdown').html(payload.first_name + " " + payload.last_name);
				$('#agentrole-headerdropdown').html("<small>" + payload.role + "</small>");

				socket.emit('register-client', {"hello": "hello"});
				socket.emit('register-agent', {"hello": "hello"}); //for AD

				//TODO: get settings from SQL
				extensionMe = payload.extension; //e.g. 6001
				queueNameMe = payload.queue_name; //e.g. InboundQueue
				channelMe = payload.channel; //e.g. SIP/7001
				pauseQueues();

			}).on('disconnect', function () {
				debugtxt('disconnect');
				console.log('disconnected');
				logout("disconnected");
			}).on("unauthorized", function (error) {
				debugtxt('unauthorized', error);
				if (error.data.type === "UnauthorizedError" || error.data.code === "invalid_token") {
					logout("Session has expired");
				}
			}).on('error', function (reason) {
				debugtxt('error', reason);

				if (reason.code === "invalid_token") {
					logout("Session has expired");
				} else {
					logout("An Error Occurred: " + JSON.stringify(reason));
				}
			}).on('typing', function (data) {
				debugtxt('typing', data);
				if ($("#txtAgentDisplayName").val() !== data.displayname) {
					$('#rtt-typing').html(data.displayname + ": " + data.rttmsg);
				}
			}).on('typing-clear', function (data) {
				debugtxt('typing-clear', data);
				if ($("#txtAgentDisplayName").val() !== data.displayname) {
					$('#rtt-typing').html('');
				}
			}).on('new-caller', function (data) { // a new caller has connected
				debugtxt('new-caller', data);
				
				//filter out messages not destined for me
				if (data.id != extensionMe) {
					return;
				}
				
				clearScreen();

				$('#callerFirstName').val(data.data[0].first_name);
				$('#callerLastName').val(data.data[0].last_name);
				$('#callerAddress1').val(data.data[0].address);
				$('#callerCity').val(data.data[0].city);
				$('#callerState').val(data.data[0].state);
				$('#callerZipcode').val(data.data[0].zip_code);
				$('#callerPhone').val(data.data[0].vrs);
				$('#callerEmail').val(data.data[0].email);

				$('#inboundnumber').text(data.srcPhoneNum);
				$('#outboundnumber').text($('#destexten').val());

				if (data.vrscaller) {
					$('#inbounddhohlabel').show();
				} else {
					$('#outbounddhohlabel').show();
				}

				$('#duration').timer('reset');
				inCall();
			}).on('new-caller-general', function (data) { // a new general caller has connected
				debugtxt('new-caller-general', data);
				$('#duration').timer('reset');
				inCallADGeneral();
			}).on('new-caller-complaints', function (data) {
				// a new complaints caller has connected
				debugtxt('new-caller-complaints', data);
				$('#duration').timer('reset');
				inCallADComplaints();
			}).on('new-ticket', function (data) {
				debugtxt('new-ticket', data);
				if (data.message === "success") {
					clearScreen();
					$('#callerFirstName').val(data.first_name);
					$('#callerLastName').val(data.last_name);
					$('#callerUniqueID').val('');
					$('#callerAddress1').val(data.address);
					$('#callerCity').val(data.city);
					$('#callerState').val(data.state);
					$('#callerZipcode').val(data.zip_code);
					$('#callerPhone').val(data.vrs);
					$('#callerEmail').val(data.email);
					$('#ticketId').val(data.zendesk_ticket);
					$('#subject').val(data.subject);
					$('#problemdesc').val(data.description);
					$('#duration').timer('reset');

					// Registers the agent to a private room with the vrs user.
					socket.emit('register-vrs', {"vrs": data.vrs});
				}


			}).on('no-ticket-info', function (data) {
				debugtxt('no-ticket-info', data);
				$('#notickettxt').show();
				$('#ticketTab').addClass("bg-pink");
				ticketTabFade = setInterval(function () {
					$('#ticketTab').fadeTo("slow", 0.1).fadeTo("slow", 1.0);
				}, 1000);
			}).on('chat-leave', function (data) {
				debugtxt('chat-leave', data);
				$('#duration').timer('pause');
				$('#user-status').text('Wrap Up');
				$('#status-icon').removeClass("text-green");
				$('#status-icon').removeClass("text-yellow");
				$('#status-icon').addClass("text-red");
				$('#complaintsInCall').hide();
				$('#geninfoInCall').hide();
				socket.emit('wrapup', null);
				socket.emit('chat-leave-ack', data);
			}).on('populate-destexten', function (data) { // Node is populating the out number hidden field
				debugtxt('populate-destexten', data);
				//filter out messages not destined for me
				if (data.id != extensionMe) {
					return;
				}

				$('#destexten').val(data.destexten);
				$('#outboundnumber').text(data.destexten);
			}).on('call-ended', function (data) {
				debugtxt('call-ended', data);
				//END TIMER
				$('#duration').timer('pause');
				pauseQueues();
			}).on('chat-message-new', function (data) {
				debugtxt('chat-message-new', data);
				var msg = data.message;
				var displayname = data.displayname;
				var timestamp = data.timestamp;

				msg = msg.replace(/:\)/, '<i class="fa fa-smile-o fa-2x"></i>');
				msg = msg.replace(/:\(/, '<i class="fa fa-frown-o fa-2x"></i>');

				var msgblock = document.createElement('div');
				var msginfo = document.createElement('div');
				var msgsender = document.createElement('span');
				var msgtime = document.createElement('span');
				var msgtext = document.createElement('div');

				if ($("#txtAgentDisplayName").val() === displayname) {
					$(msgsender).addClass("direct-chat-name pull-right").html(displayname).appendTo(msginfo);
					$(msgtime).addClass("direct-chat-timestamp pull-left").html(timestamp).appendTo(msginfo);
					$(msginfo).addClass("direct-chat-info clearfix").appendTo(msgblock);
					$(msgtext).addClass("direct-chat-text").html(msg).appendTo(msgblock);
					$(msgblock).addClass("direct-chat-msg right").appendTo($("#chat-messages"));
				} else {
					$('#rtt-typing').html('');
					$(msgsender).addClass("direct-chat-name pull-left").html(displayname).appendTo(msginfo);
					$(msgtime).addClass("direct-chat-timestamp pull-right").html(timestamp).appendTo(msginfo);
					$(msginfo).addClass("direct-chat-info clearfix").appendTo(msgblock);
					$(msgtext).addClass("direct-chat-text").html(msg).appendTo(msgblock);
					$(msgblock).addClass("direct-chat-msg").appendTo($("#chat-messages"));
				}
				$("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
			}).on('script-data', function (data) {
				debugtxt('script-data', data);
				assistanceURL = data.assistance;
				for (var i in data.data) {
					if (data.data[i].id === 1)
						$('#info_script_content').val(data.data[i].text);
					if (data.data[i].id === 2)
						$('#complaints_script_content').val(data.data[i].text);
				}
			}).on('ad-zendesk', function (data) {
				debugtxt('ad-zendesk', data);
				//Place holders
				//$('#assignee').val('');
				//$('#requester').val('');
				//$('#resolution').val('');
				$('#ticketId').val(data.id);
				$('#lastupdated').val(data.updated_at);
				$('#subject').val(data.subject);
				$('#problemdesc').val(data.description);
			}).on('ad-vrs', function (data) {
				debugtxt('ad-vrs', data);
				$('#callerFirstName').val(data.data[0].first_name);
				$('#callerLastName').val(data.data[0].last_name);
				$('#callerPhone').val(data.data[0].vrs);
				$('#callerAddress1').val(data.data[0].address);
				$('#callerCity').val(data.data[0].city);
				$('#callerState').val(data.data[0].state);
				$('#callerZipcode').val(data.data[0].zip_code);
				$('#callerEmail').val(data.data[0].email);

				$('#duration').timer('reset');
				socket.emit('register-vrs', {"vrs": data.data[0].vrs});
			}).on('missing-vrs', function (data) {
				debugtxt('missing-vrs', data);
				//show modal to get VRS from user
				$(".modal-backdrop").remove();
				if (data.message) {
					$('#ivrsmessage').text(data.message);
					$('#ivrsmessage').show();
				}
				$('#myVrsModal').modal({show: true, backdrop: 'static', keyboard: false});
			}).on('ad-zendesk-update-success', function (data) {
				debugtxt('ad-zendesk-update-success', data);
				$('#alertPlaceholder').html('<div id="saveAlert" class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>Success!</div>');
				$('#lastupdated').val(data.updated_at);
			}).on('ad-ticket-created', function (data) {
				debugtxt('ad-ticket-created', data);
				$('#alertPlaceholder').html('<div id="saveAlert" class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>Success!</div>');
				$('#lastupdated').val("");
				$('#subject').val(data.subject);
				$('#problemdesc').val(data.description);
				$('#ticketId').val(data.zendesk_ticket);
			}).on('agent-status-list', function (data) {
				//debugtxt('agent-status-list', data);
				var name, status, extension, queues, tabledata;
				if(data.message === "success"){
					tabledata = {data:[]};
					for(var i = 0; i < data.agents.length; i++ ){
						var name, status, extension, queues = "";
						name = data.agents[i].name;
						status = data.agents[i].status;
						if(status === "READY"){
							status = "<div style='display:inline-block'><i class='fa fa-circle text-green'></i>&nbsp;&nbsp;Ready</div>";
						}else if(status === "AWAY"){
							status = "<div style='display:inline-block'><i class='fa fa-circle text-yellow'></i>&nbsp;&nbsp;Away</div>";
						}else if(status === "INCALL"){
							status = "<div style='display:inline-block'><i class='fa fa-circle text-red'></i>&nbsp;&nbsp;In Call</div>";
						}else if(status === "WRAPUP"){
							status = "<div style='display:inline-block'><i class='fa fa-circle text-red'></i>&nbsp;&nbsp;Wrap Up</div>";
						}else{
							status = "<div style='display:inline-block'><i class='fa fa-circle text-white'></i>&nbsp;&nbsp;Unknown</div>";
						}
						
						extension = data.agents[i].extension;
						for(var j = 0; j < data.agents[i].queues.length; j++){
							queues += data.agents[i].queues[j].queuename + "<br>";
						}
						queues = queues.replace(/<br>\s*$/, "");
						tabledata['data'].push({"status":status,"name":name,"extension":extension,"queues":queues});					
					}
					
					$('#agenttable').dataTable().fnClearTable();
					$('#agenttable').dataTable().fnAddData(tabledata.data);													
				}
			});


		}
		
		$('#agenttable').DataTable( {
			aaData: null,
			aoColumns: [
				{ "mDataProp": "status" },
				{ "mDataProp": "name" },
				{ "mDataProp": "extension" },
				{ "mDataProp": "queues" }
			],
			searching: false,
			paging: false,
			scrollY: 600,
			order: []					
		} );

		$("#ivrsnum").keyup(function (event) {
			if (event.keyCode == 13) {
				$("#submitvrs").click();
			}
		});

		$('#submitvrs').on('click', function (event) {
			event.preventDefault(); // To prevent following the link (optional)
			var ivrsnum = $('#ivrsnum').val().replace(/^1|[^\d]/g, '');
			if (ivrsnum.length === 10) {
				$(".modal-backdrop").remove();
				socket.emit('input-vrs', {"vrs": ivrsnum, "extension": extensionMe});
				$('#ivrsnum').removeClass('has-error');
				$('#ivrsmessage').text('');
				$('#ivrsmessage').hide();
				$('#myVrsModal').modal('hide');
			} else {
				$('#ivrsnum').addClass('has-error');
				$('#ivrsmessage').text('Invalid phone number format');
				$('#ivrsmessage').show();
			}
		});


		$("#newchatmessage").on('change keydown paste input', function () {
			var value = $("#newchatmessage").val();
			var displayname = $('#txtAgentDisplayName').val();
			var vrs = $('#callerPhone').val();

			if (value.length > 0) {
				socket.emit('chat-typing', {"displayname": displayname, "vrs": vrs, rttmsg: value});
			} else {
				socket.emit('chat-typing-clear', {"displayname": displayname, "vrs": vrs});
			}
		});

		$('#chatsend').submit(function (evt) {
			evt.preventDefault();

			var msg = $('#newchatmessage').val();
			var displayname = $('#txtAgentDisplayName').val();
			var vrs = $('#callerPhone').val();
			var date = moment();
			var timestamp = date.format("D MMM h:mm a");

			$('#newchatmessage').val('');
			socket.emit('chat-message', {"message": msg, "timestamp": timestamp, "displayname": displayname, "vrs": vrs});
		});

		$('#ticketTabTitle').click(function () {
			$('#ticketTab').removeClass("bg-pink");
			clearInterval(ticketTabFade);
		});

		function requestAssistance() {
			$.ajax({
				url: assistanceURL,
				data: {
					extension: extensionMe
				},
				type: 'GET',
				dataType: 'json',
				success: function (data) {
					;
				},
				error: function (xhr, status, error) {
					console.log('Error');
				}
			});
		}

		function logout(msg) {
			//clear the token from session storage
			sessionStorage.clear();
			//disconnect socket.io connection
			if (socket)
				socket.disconnect();
			//display the login screen to the user.
			if (msg) {
				window.location.replace("/login.html?message=" + msg);
			} else {
				window.location.replace("/login.html");
			}

		}

		function modifyTicket() {
			$('#notickettxt').hide();
			var id = $('#ticketId').val();
			var subject = $('#subject').val();
			var description = $('#problemdesc').val();
			var resolution = $('#resolution').val();
			var fname = $('#callerFirstName').val();
			var email = $('#callerEmail').val(); //
			var phone = $('#callerPhone').val();
			var lname = $('#callerLastName').val();

			if (id.trim() === "") {
				var ticket = {"destexten": extensionMe, "vrs": phone, "status": "new", "ticketId": id, "subject": subject, "description": description, "name": fname, "email": email, "phone": phone, "last_name": lname, "resolution": resolution, "comment": {"public": true, "body": description}};				
				socket.emit('ad-ticket', ticket);
			} else {
				socket.emit('modify-ticket', {"destexten": extensionMe, "vrs": phone, "status": "new", "ticketId": id, "subject": subject, "description": description, "name": fname, "email": email, "phone": phone, "last_name": lname, "resolution": resolution, "comment": {"public": true, "body": description}});
			}

		}

		function inCall() {
			$('#user-status').text('In Call');
			$('#status-icon').removeClass("text-green");
			$('#status-icon').addClass("text-red");
			var param1 = [{"Interface": "SIP/" + extensionMe, "Queue": ""}, {"Interface": "", "Queue": ""}];
			socket.emit('pause-queues', param1);
		}

		function inCallADComplaints() {
			pauseQueues();
			$('#user-status').text('In Call');
			$('#status-icon').removeClass("text-green");
			$('#status-icon').removeClass("text-yellow");
			$('#status-icon').addClass("text-red");
			$('#complaintsInCall').show();
			socket.emit('incall', null);
		}

		function inCallADGeneral() {
			pauseQueues();
			$('#user-status').text('In Call');
			$('#status-icon').removeClass("text-green");
			$('#status-icon').removeClass("text-yellow");
			$('#status-icon').addClass("text-red");
			$('#geninfoInCall').show();
			socket.emit('incall', null);
		}

		function pauseQueues() {
			$('#user-status').text('Away');
			$('#status-icon').removeClass("text-green");
			$('#status-icon').addClass("text-yellow");

			socket.emit('pause-queues', null);
			socket.emit('away', null);
		}

		function unpauseQueues() {
			$('#user-status').text('Ready');
			$('#status-icon').removeClass("text-yellow");
			$('#status-icon').addClass("text-green");

			socket.emit('unpause-queues', null);
			socket.emit('ready', null);
		}

		function finished() {
			$('#destexten').val('');
			clearScreen();
			unpauseQueues();
			$('#alertPlaceholder').html('');
		}

		function clearScreen() {
			$('#userform').find('input:text').val('');
			$('#callerEmail').val('');

			$('#callinfodiv').find('input:text').val('');

			$('#inbounddhohlabel').hide();
			$('#outbounddhohlabel').hide();

			$('#outboundnumber').text('');
			$('#inboundnumber').text('');

			$('#duration').timer('reset');
			$('#duration').timer('pause');

			$('#chat-messages').html('');
			$('#newchatmessage').val('');

			$('#ticketForm').find('input:text').val('');
			$('#ticketForm').find('textarea').val('');

			$('#complaintsInCall').hide();
			$('#geninfoInCall').hide();

			$('#ivrsnum').val('');
			$('#ivrsmessage').hide();

			$('#notickettxt').hide();
			$('#ticketTab').removeClass("bg-pink");
			clearInterval(ticketTabFade);
		}

		function originate() {
			//send username and number to call
			console.log(" ******************* Connecting Call *******************");
			socket.emit('outbound-call', {"username": $('#loginusername').val(), "exten": $('#destexten').val()}); //TODO: hard-coded exten for now
		}
		
		$(document).ready(function () {
			connect_socket();
						
			$("#debugtab").hide();
			$('#scriptstab').hide();
			$("#geninfotab").hide();
			$("#complaintstab").hide();
			$("[data-mask]").inputmask();				

			clearScreen();

			$.getJSON("licenses.json", function (data) {
				$.each(data.license, function (i) {
					$("#licModalBody").append("<h3>" + data.license[i].name + "<h3><pre>" + data.license[i].pre + "</pre>");
				});
			});

			if (window.addEventListener) {
				var state = 0, theCode = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
				window.addEventListener("keydown", function (e) {
					if (e.keyCode === theCode[state]) {
						state++;
					} else {
						state = 0;
					}
					if (state === 10) {
						$("#debugtab").show();
					}
				}, true);
			}
		});
		
		// Debug Functions for sidebar.
		function cleardbgtxt() {
			$('#dbgtxt').html('');
		}
		function debugtxt(title, data) {
			var dt = new Date();
			var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
			$('#dbgtxt').html('<span style="color:green">' + time + ": " + title + '</span><br>' + JSON.stringify(data) + '<br>----------------<br>' + $('#dbgtxt').html());
		}
        </script>
    </body>
</html>
